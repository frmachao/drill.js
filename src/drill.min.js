(e=>{const t=new Map,a=new Map,r=new Map,s=new Map,l={};let n={loadNum:3,time:1e3,backups:new Set},c={processors:t,loaders:a,bag:r,paths:s,dirpaths:l,errInfo:n,baseUrl:"",tempM:{}};const i=()=>Math.random().toString(32).substr(2);var o=Object.prototype.toString;const d=e=>(e=>o.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;const p=(()=>{let e=!1,t=[];return a=>{e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a)}})();a.set("css",e=>{let t=document.createElement("link");t.rel="stylesheet",t.href=e.link,t.onload=(()=>{e.stat=3}),t.onerror=(()=>{e.stat=2}),document.head.appendChild(t)}),a.set("json",async e=>{try{await fetch(e.link)}catch(t){return void(e.stat=2)}data=await data.json(),e.getPack=(async()=>data),e.stat=3}),t.set("file",e=>{e.stat=3}),t.set("define",async e=>{let t=c.tempM.d,a={},r={exports:a};if(d(t)){let{path:s}=e;t=t((...t)=>h(k(t,e.dir)),a,r,{FILE:s})}t instanceof Promise&&(t=await t),t||(e=>!(0 in Object.keys(e)))(r.exports)||(t=r.exports),e.getPack=(async()=>t),e.stat=3}),t.set("task",e=>{let t=c.tempM.d;if(!d(t))throw"task must be a function";e.getPack=(async e=>{return await t((...t)=>h(k(t,e.dir)),e.data,{FILE:e.path})}),e.stat=3}),a.set("js",e=>{let a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=e.link,a.addEventListener("load",()=>{let{tempM:a}=c,{type:s,moduleId:l}=a;l&&(r.get(l)||r.set(l,e));let n=t.get(s||"file");if(!n)throw"no such this processor => "+s;n(e),c.tempM={}}),a.addEventListener("error",()=>{e.stat=2}),document.head.appendChild(a)});let u=e=>{let t=r.get(e.path);if(!t){let s=1;t={get stat(){return s},set stat(e){let t=s;s=e,this.changes.forEach(e=>e({change:"stat",oldStat:t,stat:s}))},path:e.path,link:e.link,dir:e.dir,changes:new Set,fileType:e.fileType,async getPack(e){}},r.set(e.path,t);let l=a.get(e.fileType);if(!l)throw"no such this loader => "+t.fileType;l(t)}return new Promise((r,s)=>{switch(t.stat){case 2:case 1:let l;t.changes.add(l=(c=>{let{stat:i}=c;switch(i){case 3:t.getPack(e).then(r),t.changes.delete(l),t=null;break;case 2:if((void 0!=t.loadCount?t.loadCount:t.loadCount=0)<n.loadNum){t.loadCount++;let e=a.get(t.fileType);setTimeout(()=>e(t),n.time)}else{let{backups:e}=n;if(e.size){let r=void 0!=t.backupId?t.backupId:t.backupId=-1;if(r<e.size){let s=Array.from(e),l=s[r]||t.dir,c=s[r=++t.backupId];t.loadCount=1,t.link=t.link.replace(new RegExp("^"+l),c);let i=a.get(t.fileType);return void setTimeout(()=>i(t),n.time)}}t.stat=4}break;case 4:s("source error")}}));break;case 3:p(()=>{t.getPack(e).then(r)});break;case 4:s("source error")}})},h=e=>{let t,a=new Promise((a,r)=>{let s=[],{length:l}=e,n=l,c=[];e.forEach(async(e,i)=>{let o="succeed",d=await u(e).catch(t=>{o="error",Object.assign(e,{type:"error",descript:t}),c.push(e)});s[i]=d,t&&t({id:i,sum:n,ready:n-l+1,stat:o}),--l||(c.length?r(c):a(1==n?d:s),s=null)})});return a.post=function(t){return e.forEach(e=>e.data=t),this},a.pend=function(e){return t=e,this},a},f=e=>{let{str:t}=e,a=t.split(/\s/).filter(e=>e&&e),r=a.slice(1),n=a[0],i=n.match(/(.+)\?(\S+)$/)||"";i&&(n=i[1],i=i[2]);let{k:o,v:d}=g.cacheInfo;o&&d&&(i&&(i+="&"),i+=o+"="+d);let p=s.get(n);if(p)n=p;else for(let e in l){let t=l[e];if(t.reg.test(n)){n=n.replace(t.reg,t.value);break}}let u=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(n)||"js";n=n.replace(new RegExp("\\."+u+"$"),"");let h;if(r.includes("-pack")){let e=h.match(/(.+)\/(.+)/);2 in e&&(n=h=e[1]+"/"+e[2]+"/"+e[2])}h=(h=r.indexOf("-r")>-1||/^.+:\/\//.test(n)?n:/^\./.test(n)?e.relative?e.relative+n:n.replace(/^\.\//,""):c.baseUrl+n).replace(/\/\.\//,"/"),/\.\.\//.test(h)&&(h=(e=>{let t=[];return e.split(/\//g).forEach(e=>{".."==e&&t.length&&".."!=t.slice(-1)[0]?t.pop():t.push(e)}),t.join("/")})(h));let f=(e=>{let t=e.match(/(.+\/).+/);return t&&t[1]})(h+="."+u),k=i?h+"?"+i:h;return Object.assign(e,{link:k,search:i,ori:n,fileType:u,path:h,dir:f,param:r}),e};const k=(e,t)=>{let a=i();return e.map((e,r)=>f({loadId:i(),id:r,str:e,groupId:a,relative:t}))},g={load:(...e)=>h(k(e)),remove(e){let{path:t}=f({str:e});if(r.has(t))return r.delete(t),!0;console.warn(`pack %c${e}`,"color:red","does not exist")},config(e){e.baseUrl&&(c.baseUrl=e.baseUrl);let t=e.paths;t&&Object.keys(t).forEach(e=>{/\/$/.test(e)?l[e]={reg:new RegExp("^"+e),value:t[e]}:s.set(e,t[e])}),c.baseUrl&&e.backups&&e.backups.forEach(e=>{n.backups.add(e)})},define(e,t){c.tempM={type:"define",d:e,moduleId:t}},task(e,t){c.tempM={type:"task",d:e,moduleId:t}},ext(e,t){if(d(e))e(c);else{let a,r=(...e)=>t(e,a,c);switch(e){case"fixUrlObj":a=f,f=r;break;case"load":a=h,h=r;break;case"agent":a=u,u=r}}},cacheInfo:{k:"d_ver",v:""}};e.load||(e.load=g.load),e.define||(e.define=g.define),e.task||(e.task=g.task);let m=document.currentScript;if(!m&&(m=document.querySelector(["drill-cache"])),m){let e=m.getAttribute("drill-cache");e&&(g.cacheInfo.v=e)}let b=e.drill;Object.defineProperty(e,"drill",{get:()=>g,set(e){d(e)?e(g):console.error("drill type error =>",e)}}),b&&b(g)})(window);