(e=>{"use strict";let t={},a={},r={},s={},l={loadNum:2,time:2e3},i={paths:t,dirpaths:a,baseUrl:"",bag:r,tempM:{}};const n=(()=>{let e=!1,t=[];return a=>(e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a),a)})();const o=e=>new Promise(e),c=(e,t)=>e.forEach(t),{assign:p,defineProperty:d,keys:h}=Object;var u=Object.prototype.toString,m=e=>(e=>u.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;let f={css:e=>o(t=>{let a=document.createElement("link");a.rel="stylesheet",a.href=e.link,a.onload=(()=>{t({stat:1})}),a.onerror=(()=>{t({stat:0})}),r[e.path].stat=3,document.head.appendChild(a)}),json:async e=>{r[e.path].stat=3;let t=await fetch(e.link);return t=await t.json(),{stat:1,o:{get:async()=>t}}}};class b{constructor(e){p(this,{tobe:[],fileType:e,get:async()=>{},_sl:[]});let t=2;d(this,"stat",{set(e){c(this._sl,t=>t(e,this._stat)),t=e},get:()=>t})}statChange(e){this._sl.push(e)}}let y=e=>{let t=e.split(/\s/).filter(e=>e&&e),a=t[0],r=a.match(/(.+)\?(\S+)$/)||"";r&&(a=r[1],r=r[2]);let{k:s,v:i}=S.cacheInfo;s&&i&&(r&&(r+="&"),r+=s+"="+i);let{loadNum:n}=l,o=l.time;return{str:e,ori:a,search:r,param:t.slice(1),loadNum:n,errLoadTime:o,hand:{rid:Math.random().toString(32).substr(2)}}},g=e=>{let{ori:r}=e,s=t[r];if(s)r=s;else for(let e in a){let t=a[e],s=t.r;if(s.test(r)){r=r.replace(s,t.v);break}}let l=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(r);l&&f[l]||(l="js"),e.fileType=l;let n=r=r.replace(new RegExp("\\."+l+"$"),"");if(e.param.indexOf("-pack")>-1){let e=n.match(/(.+)\/(.+)/);2 in e&&(r=n=e[1]+"/"+e[2]+"/"+e[2])}return n=e.param.indexOf("-r")>-1?r:/^\./.test(r)?e.rel?e.rel+r:r.replace(/^\.\//,""):i.baseUrl+r,n=n.replace(/\/\.\//,"/"),/\.\.\//.test(n)&&(n=(e=>{let t=e.split(/\//g),a=[];return c(t,e=>{".."==e&&a.length&&".."!=a.slice(-1)[0]?a.pop():a.push(e)}),a.join("/")})(n)),n+="."+e.fileType,e.path=n,e.dir=(e=>{let t=e.match(/(.+\/).+/);return t&&t[1]})(n),e.link=n+"?"+e.search,e},k=e=>{let t,a=o((a,r)=>{n(()=>{let s=e.length,l=s;switch(s){case 0:throw"no resource path";case 1:w(e[0]).then(e=>{t&&t({id:0,sum:l,ready:1,stat:1}),a(e)}).catch(e=>{r()});break;default:let i=[],n=[];c(e,async(o,c)=>{let p=1,d=await w(o).catch(()=>{n.push(c),p=0});i[c]=d,t&&t({id:c,sum:l,ready:l-s+1,stat:p}),--s||(0 in n?(r({errors:n,result:i}),S.onerror&&S.onerror({errors:n,result:i,args:e.map(e=>e.str)})):a(i))})}})});return a.post=(t=>(c(e,e=>{e.data=t}),a)),a.pend=(e=>(t=e,a)),a},w=e=>o((t,a)=>{let{path:s}=e,l=r[s];if(!l){l=r[s]=new b(e.fileType);let{loadNum:t}=e,a=()=>{j(e).then(i=>{if(p(l,i.o),1==i.stat)l.stat=1,c(l.tobe,e=>{e.res()});else{if(t)return l.stat=4,t--,void setTimeout(()=>{a()},e.errLoadTime);l.stat=i.stat,c(l.tobe,e=>{console.error(i.stat+" "+i.msg),e.rej()}),delete r[s]}delete l.tobe,a=null})};a()}switch(l.stat){case 1:l.get(e).then(t);break;case 2:case 3:case 4:l.tobe.push({res(){l.get(e).then(t)},rej:a})}}),j=async e=>{let t,{fileType:a}=e;return t="js"===a?await T(e):f[a]?await f[a](e):{stat:100,msg:"no this fileType => ."+e.fileType}},T=async e=>{let t=await v(e),{tempM:a}=i,{type:l,moduleId:n}=a;if(i.tempM={},n&&(r[n]||(r[n]=r[e.path])),l){t.o.jsType=l,r[e.path].stat=3;let i;switch(l){case"define":i=await I(e,a);break;case"task":i=await E(e,a);break;default:let t=s[l];t&&(i=await t(e,a))}p(t.o,i)}else t.o.jsType="file";return t},v=e=>o(t=>{let{link:a,path:r}=e,s=document.createElement("script");s.type="text/javascript",s.async=!0,r&&(s.src=a),s.addEventListener("load",()=>{t({stat:1,o:{script:s}})}),s.addEventListener("error",a=>{document.head.removeChild(s),t({stat:404,msg:"load js file error => "+e.path,o:{}})}),n(()=>{document.head.appendChild(s)})}),x=(e,t)=>(...a)=>k(a.map(a=>(a=y(a),a.rel=e,a.parHand=t,g(a)))),I=async(e,t)=>{let{d:a}=t,r={},s={exports:r};if(m(a)){let{dir:t,hand:l,path:i}=e;a=a(x(t,l),r,s,{FILE:i,DIR:t})}return a instanceof Promise&&(a=await a),a||(e=>!(0 in h(e)))(s.exports)||(a=s.exports),{get:async()=>a}},E=async(e,t)=>{let{d:a}=t;if(!m(a))throw"drill's task must be a function";return{get:async e=>{let{dir:t,hand:r,path:s,data:l}=e,i=a(x(t,r),l,{FILE:s,DIR:t});return await i}}},S={baseResources:i,require:(...e)=>k(e.map(e=>g(y(e)))),loaders:f,processor:s,errInfo:l,config(e){i.baseUrl=e.baseUrl||i.baseUrl;let r=e.paths;for(let e in r)/\/$/.test(e)?a[e]={r:new RegExp("^"+e),v:r[e]}:t[e]=r[e]},cacheInfo:{k:"d_ver"},remove(e){let{path:t}=g(y(e));if(r[t])return delete r[t],!0},ext(e,t){let a,r=(...e)=>t(e,a,{baseResources:i});switch(e){case"analyzeUrl":a=y,y=r;break;case"fixPath":a=g,g=r;break;case"require":a=k,k=r;break;case"loadAgent":a=w,w=r;break;case"loadSource":a=j,j=r;break;case"loadJS":a=T,T=r;break;case"loadScript":a=v,v=r;break;case"setDefine":a=I,I=r;break;case"setTask":a=E,E=r}}};c(["define","task"],t=>{let a=S[t]=((e,a)=>{i.tempM={type:t,d:e,moduleId:a}});e[t]||(e[t]=a)});let L=document.currentScript;if(!L&&(L=document.querySelector(["drill-cache"])),L){let e=L.getAttribute("drill-cache");e&&(S.cacheInfo.v=e)}e.require||(e.require=S.require);let q=e.drill;d(e,"drill",{get:()=>S,set(e){m(e)?e(S):console.error("drill type error =>",e)}}),q&&q(S)})(window);