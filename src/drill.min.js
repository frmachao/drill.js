(e=>{"use strict";let t={},a={},r={},s={},l={},i={loadNum:2,time:2e3},o={paths:t,dirpaths:a,baseUrl:"",bag:r,tempM:{}};const c=(()=>{let e=!1,t=[];return a=>(e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a),a)})();const n=e=>new Promise(e),p=(e,t)=>e.forEach(t),{assign:d,defineProperty:h,keys:u}=Object;var m=Object.prototype.toString,f=e=>(e=>m.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;class b{constructor(e){d(this,{tobe:[],fileType:e,get:async()=>{},_sl:[]});let t=2;h(this,"stat",{set(e){p(this._sl,t=>t(e,this._stat)),t=e},get:()=>t})}statChange(e){this._sl.push(e)}}let y=e=>{let t=e.split(/\s/).filter(e=>e&&e),a=t[0],r=a.match(/(.+)\?(\S+)$/)||"";r&&(a=r[1],r=r[2]);let{k:s,v:l}=M.cacheInfo;s&&l&&(r&&(r+="&"),r+=s+"="+l);let{loadNum:o}=i,c=i.time;return{str:e,ori:a,search:r,param:t.slice(1),loadNum:o,errLoadTime:c,hand:{rid:Math.random().toString(32).substr(2)}}},g=e=>{let{ori:r}=e,l=t[r];if(l)r=l;else for(let e in a){let t=a[e],s=t.r;if(s.test(r)){r=r.replace(s,t.v);break}}let i=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(r);i&&s[i]||(i="js"),e.fileType=i;let c=r=r.replace(new RegExp("\\."+i+"$"),"");return c=e.param.indexOf("-r")>-1?r:e.rel&&/^\./.test(r)?e.rel+r:o.baseUrl+r,c=c.replace(/\/\.\//,"/"),/\.\.\//.test(c)&&(c=(e=>{let t=e.split(/\//g),a=[];return p(t,e=>{".."==e&&a.length&&".."!=a.slice(-1)[0]?a.pop():a.push(e)}),a.join("/")})(c)),c+="."+e.fileType,e.path=c,e.dir=(e=>{let t=e.match(/(.+\/).+/);return t&&t[1]})(c),e},w=e=>{let t,a=n((a,r)=>{c(()=>{let s=e.length,l=s;switch(s){case 0:throw"no resource path";case 1:k(e[0]).then(e=>{t&&t({id:0,sum:l,stat:1}),a(e)}).catch(e=>{r()});break;default:let i=[],o=[];p(e,async(e,c)=>{let n=1,p=await k(e).catch(()=>{o.push(c),n=0});i[c]=p,t&&t({id:c,sum:l,stat:n}),--s||(0 in o?r({errors:o,result:i}):a(i))})}})});return a.post=(t=>(p(e,e=>{e.data=t}),a)),a.pend=(e=>(t=e,a)),a},k=e=>n((t,a)=>{let{path:s}=e,l=r[s];if(!l){l=r[s]=new b(e.fileType);let{loadNum:t}=e,a=()=>{T(e).then(i=>{if(d(l,i.o),1==i.stat)l.stat=1,p(l.tobe,e=>{e.res()});else{if(t)return l.stat=4,t--,void setTimeout(()=>{a()},e.errLoadTime);l.stat=i.stat,p(l.tobe,e=>{console.error(i.stat+" "+i.msg),e.rej()}),delete r[s]}delete l.tobe,a=null})};a()}switch(l.stat){case 1:l.get(e).then(t);break;case 2:case 3:case 4:l.tobe.push({res(){l.get(e).then(t)},rej:a})}}),T=async e=>{let t,{fileType:a}=e;return t="js"===a?await j(e):s[a]?await s[a](e):{stat:100,msg:"no this fileType => ."+e.fileType}},j=async e=>{let t=await v(e),{tempM:a}=o,{type:s}=a;if(s){t.o.jsType=s,r[e.path].stat=3;let a;switch(s){case"define":a=await I(e);break;case"task":a=await E(e);break;default:let t=l[s];t&&(a=await t(e))}d(t.o,a)}else t.o.jsType="file";return t},v=e=>n(t=>{let{path:a,search:r}=e;r&&(a=a+"?"+r);let s=document.createElement("script");s.type="text/javascript",s.async=!0,a&&(s.src=a),s.addEventListener("load",()=>{t({stat:1,o:{script:s}})}),s.addEventListener("error",a=>{document.head.removeChild(s),t({stat:404,msg:"load js file error => "+e.path,o:{}})}),c(()=>{document.head.appendChild(s)})}),x=(e,t)=>(...a)=>w(a.map(a=>(a=y(a),a.rel=e,a.parHand=t,g(a)))),I=async e=>{let{d:t}=o.tempM;o.tempM={};let a={},r={exports:a};if(f(t)){let{dir:s,hand:l,path:i}=e;t=t(x(s,l),a,r,{FILE:i,DIR:s})}return t instanceof Promise&&(t=await t),t||(e=>!(0 in u(e)))(r.exports)||(t=r.exports),{get:async()=>t}},E=async e=>{let{tempM:t}=o,{d:a}=t;if(!f(a))throw"drill's task must be a function";return o.tempM={},{get:async e=>{let{dir:t,hand:r,path:s,data:l}=e,i=a(x(t,r),l,{FILE:s,DIR:t});return await i}}},M={require:(...e)=>w(e.map(e=>g(y(e)))),loaders:s,processor:l,errInfo:i,config(e){o.baseUrl=e.baseUrl||o.baseUrl;let r=e.paths;for(let e in r)/\/$/.test(e)?a[e]={r:new RegExp("^"+e),v:r[e]}:t[e]=r[e]},cacheInfo:{k:"d_ver"},remove(e){let{path:t}=g(y(e));if(r[t])return delete r[t],!0},ext(e,t){let a,r=(...e)=>t(e,a,{baseResources:o});switch(e){case"analyzeUrl":a=y,y=r;break;case"fixPath":a=g,g=r;break;case"require":a=w,w=r;break;case"loadAgent":a=k,k=r;break;case"loadSource":a=T,T=r;break;case"loadJS":a=j,j=r;break;case"loadScript":a=v,v=r;break;case"setDefine":a=I,I=r;break;case"setTask":a=E,E=r}}};p(["define","task"],t=>{let a=M[t]=((e,a)=>{o.tempM={type:t,d:e,moduleId:a}});e[t]||(e[t]=a)});let S=document.currentScript;if(!S&&(S=document.querySelector(["drill-cache"])),S){let e=S.getAttribute("drill-cache");e&&(M.cacheInfo.v=e)}e.require||(e.require=M.require);let L=e.drill;L&&L(M),h(e,"drill",{get:()=>M,set(e){f(e)?e(M):console.error("drill type error =>",e)}})})(window);