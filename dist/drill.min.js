/*!
* drill.js v3.5.1
* https://github.com/kirakiray/drill.js
* 
* (c) 2018-2020 YAO
* Released under the MIT License.
*/(glo=>{"use strict";const processors=new Map,loaders=new Map,bag=new Map,paths=new Map,dirpaths={};let offline=!1;const cacheDress=new Map;let errInfo={time:100,backups:[]},base={processors:processors,loaders:loaders,bag:bag,paths:paths,dirpaths:dirpaths,errInfo:errInfo,baseUrl:"",tempM:{}};const getRandomId=()=>Math.random().toString(32).substr(2);var objectToString=Object.prototype.toString,getType=e=>objectToString.call(e).toLowerCase().replace(/(\[object )|(])/g,"");const isFunction=e=>getType(e).search("function")>-1;var isEmptyObj=e=>!(0 in Object.keys(e));const nextTick=(()=>{if("undefined"!=typeof $&&void 0!==$.nextTick)return $.nextTick;if(null!==document.currentScript.getAttribute("debug"))return setTimeout;if("object"==typeof process&&process.nextTick)return process.nextTick;let e=!1,t=[];return r=>{e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(r)}})(),getFileType=e=>{let t,r=e.split("/").pop().match(/(.+)\.(.+)/);return r&&(t=r[2]),t},getDir=e=>{let t=(e=(e=e.replace(/(.+)#.+/,"$1")).replace(/(.+)\?.+/,"$1")).match(/(.+\/).*/);return t&&t[1]},removeParentPath=e=>{let t=[];return e.split(/\//g).forEach(e=>{".."==e&&t.length&&".."!=t.slice(-1)[0]?t.pop():t.push(e)}),t.join("/")},rootHref=getDir(document.location.href);loaders.set("css",e=>new Promise((t,r)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=e.link;let s=!1;a.onload=(async()=>{document.head.removeChild(a),t(async e=>(s||e.param.includes("-unAppend")||(s=!0,document.head.appendChild(a)),a))}),a.onerror=(e=>{r({desc:"load link error",target:a,event:e})}),document.head.appendChild(a)})),loaders.set("json",async e=>{let t=await fetch(e.link);return t=await t.json(),async()=>t}),loaders.set("wasm",async e=>{let t=await fetch(e.link);t=await t.arrayBuffer();let r=await WebAssembly.compile(t);const a=new WebAssembly.Instance(r);return async()=>a.exports}),loaders.set("frame",async e=>{let t=document.createElement("iframe");Object.assign(t.style,{position:"absolute","z-index":"-1",border:"none",outline:"none",opacity:"0",width:"0",height:"0"});let{link:r,path:a}=e,s=a.replace(/\.frame$/,"/frame.html"),l=r.replace(a,s);t.src=l;let i=new Map,n=()=>{bag.delete(a),document.body.removeChild(t),window.removeEventListener("message",o),o=e=n=null};e.timer=setTimeout(n,1e4);let o,c=r=>new Promise(a=>{let s=getRandomId();clearTimeout(e.timer),i.set(s,{res:a}),t.contentWindow.postMessage({type:"drillFrameTask",taskId:s,data:r.data},"*")});return window.addEventListener("message",o=(t=>{let{data:r,taskId:a}=t.data;if(i.has(a)){let e=i.get(a);i.delete(a),e.res(r)}i.size||(e.timer=setTimeout(n,1e4))})),new Promise((e,r)=>{t.addEventListener("load",t=>{e(c)}),t.addEventListener("error",e=>{n(),r()}),document.body.appendChild(t)})}),loaders.set("js",e=>new Promise((t,r)=>{let a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=e.link,a.addEventListener("load",async()=>{let r,{tempM:a}=base,{type:s,moduleId:l}=a;l&&(bag.get(l)||bag.set(l,e));let i=processors.get(s||"file");if(!i)throw"no such this processor => "+s;r=await i(e),t(r)}),a.addEventListener("error",()=>{r()}),document.head.appendChild(a)}));try{eval('\n    loaders.set("mjs", async packData => {\n        let d = await import(packData.link);\n\n        return async () => {\n            return d;\n        }\n    });\n    ')}catch(e){console.warn("browser does not support asynchronous es module")}const returnUrlSets=new Set(["png","jpg","jpeg","bmp","gif","webp"]),getLoader=e=>{let t=loaders.get(e);return t||(t=getByUtf8),returnUrlSets.has(e)&&(t=getByUrl),t},getByUtf8=async e=>{let t=await fetch(e.link);return t=await t.text(),async()=>t},getByUrl=async e=>{if(e.offlineUrl)return async()=>e.offlineUrl;let t=await fetch(e.link),r=await t.blob(),a=URL.createObjectURL(r);return async()=>a},isHttpFront=e=>/^http/.test(e);let agent=async e=>{if(e.param&&e.param.includes("-getLink")&&!offline)return Promise.resolve(e.link);let t=bag.get(e.path);if(!t){(t={stat:1,dir:e.dir,path:e.path,link:e.link,fileType:e.fileType}).passPromise=new Promise((e,r)=>{t._passResolve=e,t._passReject=r}),bag.set(e.path,t);let r=[t.link];const a=e=>{t.stat=4,t._passReject({desc:"load source error",link:r,packData:t})};for(;;)try{t.link=await cacheSource({packData:t}),t.getPack=await getLoader(e.fileType)(t)||(async()=>{}),t.stat=3,t._passResolve();break}catch(s){if(t.stat=2,isHttpFront(e.str))break;let{backups:l}=errInfo;if(!l.length){a();break}{let e=void 0!=t.backupId?t.backupId:t.backupId=-1;if(!(e<l.length)){t.stat=4,a();break}{let s=l[e]||base.baseUrl,i=location.href.replace(/(.+\/).+/,"$1");isHttpFront(s)||(s=i+s);let n=l[e=++t.backupId];if(!n){a();break}isHttpFront(n)||(n=i+n),t.link=t.link.replace(new RegExp("^"+s),n),r.push(t.link),await new Promise(e=>setTimeout(e,errInfo.time))}}}}return await t.passPromise,e.param&&e.param.includes("-getLink")&&offline?Promise.resolve(t.link):await t.getPack(e)};const drill={load:(...e)=>load(toUrlObjs(e)),remove(e){let{path:t}=fixUrlObj({str:e});if(bag.has(t))return bag.delete(t),!0;console.warn(`pack %c${e}`,"color:red","does not exist")},has(e){let{path:t}=fixUrlObj({str:e}),r=bag.get(t);return r&&r.stat},config(e){e.baseUrl&&(base.baseUrl=e.baseUrl);let t=e.paths;t&&Object.keys(t).forEach(e=>{let r=t[e];if(/^@.+\/$/.test(e)){let t="^"+e;r=r.replace(/\/\.\//,"/"),/^\.\./.test(r)?r=removeParentPath(rootHref+base.baseUrl+r):/^\//.test(r)&&(r=location.origin+r);let a=new RegExp(t);dirpaths[e]={reg:a,value:r}}else/^\w+$/.test(e)?paths.set(e,r):console.warn("this Paths settings do not meet specifications",e)}),base.baseUrl&&e.backups&&e.backups.forEach(e=>errInfo.backups.push(e))},ext(e,t){if(isFunction(e))e(base);else{let r,a=(...e)=>t(e,r,base);switch(e){case"fixUrlObj":r=fixUrlObj,fixUrlObj=a;break;case"load":r=load,load=a;break;case"agent":r=agent,agent=a;break;case"cacheSource":r=cacheSource,cacheSource=a}}},cacheInfo:{k:"d_ver",v:""},get offline(){return offline},set offline(e){offline?console.error("offline mode has been activated"):offline=e},debug:{bag:bag},version:"3.5.1",v:3005001},setProcessor=(e,t)=>{processors.set(e,async e=>{let r=base.tempM.d;return base.tempM={},await t(e,r,{relativeLoad:(...t)=>load(toUrlObjs(t,e.dir))})});let r=(t,r)=>{base.tempM={type:e,d:t,moduleId:r}};drill[e]||(drill[e]=r),glo[e]||(glo[e]=r)},setCacheDress=(e,t)=>{cacheDress.set(e,async({file:e,packData:r})=>{let a=e,s=await e.text(),l=await t({fileText:s,file:e,relativeLoad:(...e)=>load(toUrlObjs(e,r.dir))});return s!==l&&(a=new File([l],e.name,{type:e.type})),a})};let load=e=>{let t,r=new Promise((r,a)=>{let s=[],{length:l}=e,i=l,n=[];e.forEach(async(e,o)=>{let c,d="succeed";await new Promise(e=>nextTick(e)),c=await agent(e).catch(t=>{d="error",Object.assign(e,{type:"error",descript:t}),n.push(e)}),s[o]=c,t&&t({id:o,sum:i,ready:i-l+1,stat:d}),--l||(n.length?a(n):r(1==i?c:s),s=null)})});return r.post=function(t){return e.forEach(e=>e.data=t),this},r.pend=function(e){return t=e,this},r},fixUrlObj=e=>{let{str:t}=e;if(bag.has(t)){let r=bag.get(t);return Object.assign(e,{path:r.path,link:r.link,dir:r.dir}),e}let r=t.split(/\s/).filter(e=>e&&e),a=r.slice(1),s=r[0],l=s.match(/(.+)\?(\S+)$/)||"";l&&(s=l[1],l=l[2]);let{k:i,v:n}=drill.cacheInfo;i&&n&&!a.includes("-unCacheSearch")&&(l&&(l+="&"),l+=i+"="+n);let o=paths.get(s);if(o)s=o;else for(let e in dirpaths){let t=dirpaths[e];if(t.reg.test(s)){s=s.replace(t.reg,t.value);break}}let c,d=getFileType(s)||"js";if(s=s.replace(new RegExp("\\."+d+"$"),""),c=a.includes("-r")||/^.+:\/\//.test(s)?s:/^\//.test(s)?location.origin+s:/^\./.test(s)?e.relative?e.relative+s:s.replace(/^\.\//,""):base.baseUrl+s,a.includes("-pack")||a.includes("-p")){let e=c.match(/(.+)\/(.+)/);c=e&&2 in e?`${e[1]}/${e[2]}/${e[2]}`:`${c}/${c}`}/^.+:\/\//.test(c)||(c=rootHref+c),c=c.replace(/\/\.\//,"/"),/\.\.\//.test(c)&&(c=removeParentPath(c)),/\/$/.test(c)||(c+="."+d);let p=getDir(c),u=l?c+"?"+l:c;return a.includes("-mjs")&&(d="mjs"),Object.assign(e,{link:u,search:l,fileType:d,path:c,dir:p,param:a}),e};const toUrlObjs=(e,t)=>{let r=getRandomId();return e.map((e,a)=>fixUrlObj({loadId:getRandomId(),id:a,str:e,groupId:r,relative:t}))};processors.set("file",e=>{}),setProcessor("define",async(e,t,{relativeLoad:r})=>{let a={},s={exports:a};if(isFunction(t)){let{path:l,dir:i}=e;t=t(r,a,s,{FILE:l,DIR:i})}return t instanceof Promise&&(t=await t),t||isEmptyObj(s.exports)||(t=s.exports),async()=>t}),setProcessor("task",(e,t,{relativeLoad:r})=>{if(!isFunction(t))throw"task must be a function";let{path:a,dir:s}=e;return async e=>{return await t(r,e.data,{FILE:a,DIR:s})}}),setProcessor("init",(e,t,{relativeLoad:r})=>{if(!isFunction(t))throw"init must be a function";let a,{path:s,dir:l}=e,i=0;return async e=>i?a:(a=await t(r,e.data,{FILE:s,DIR:l}),i=1,a)}),setCacheDress("css",async({fileText:e,relativeLoad:t})=>{let r=e.match(/@import ["'](.+?)["']/g);r&&await Promise.all(r.map(async r=>{let a=r.replace(/@import ["'](.+?)["']/,"$1"),s=await t(`${a} -getLink`);e=e.replace(r,`@import "${s}"`)}));let a=e.match(/url\((.+?)\)/g);return a&&await Promise.all(a.map(async r=>{let a=r.replace(/url\((.+?)\)/,"$1").replace(/["']/g,"");if(/(^http:)|(^https:)/.test(a))return Promise.resolve("");let s=await t(`${a} -getLink`);e=e.replace(r,`url("${s}")`)})),e}),setCacheDress("mjs",async({fileText:e,relativeLoad:t})=>{let r=e.match(/import .+ from ['"](.+?)['"];/g);r&&await Promise.all(r.map(async r=>{let a=r.match(/(import .+ from) ['"](.+?)['"];/,"$1");if(a){let s=a[2],l=await t(`${s} -getLink`);e=e.replace(r,`${a[1]} "${l}"`)}}));let a=e.match(/import\(.+?\)/g);return a&&await Promise.all(a.map(async r=>{let a=r.replace(/import\(["'](.+?)['"]\)/,"$1"),s=await t(`${a} -getLink`);e=e.replace(r,`import("${s}")`)})),e});const DBNAME="drill-cache-db",FILESTABLENAME="files";let mainDB,isInitDB=new Promise((e,t)=>{const r=glo.indexedDB||glo.webkitIndexedDB||glo.mozIndexedDB||glo.msIndexedDB;if(r){let t=r.open(DBNAME,drill.cacheInfo.v||1);t.onupgradeneeded=(e=>{let t=e.target.result;t.objectStoreNames.contains(FILESTABLENAME)?(t.deleteObjectStore(FILESTABLENAME),t.createObjectStore(FILESTABLENAME,{keyPath:"path"})):t.createObjectStore(FILESTABLENAME,{keyPath:"path"})}),t.onsuccess=(t=>{mainDB=t.target.result,e()})}else t("rubish browser no indexDB")}),cacheSource=async({packData:e})=>{if(!offline)return e.link;await isInitDB;let t=await getFile(e.path);if(!t){let r=await fetch(e.link);if(200!=r.status)throw{type:"cacheSource",desc:"statusError",status:r.status};let a=r.headers.get("Content-Type").replace(/;.+/,""),s=e.path.replace(/.+\//,""),l=await r.blob();t=new File([l],s,{type:a}),await saveFile(e.path,t)}let r=cacheDress.get(e.fileType);return r&&(t=await r({file:t,packData:e})),e.offlineFile=t,e.offlineUrl=URL.createObjectURL(t)};const getFile=e=>new Promise((t,r)=>{let a=mainDB.transaction([FILESTABLENAME],"readonly").objectStore(FILESTABLENAME).get(e);a.onsuccess=(()=>{t(a.result&&a.result.data)}),a.onerror=(t=>{r(),console.error(`error load ${e}`,t)})}),saveFile=(e,t)=>new Promise((r,a)=>{let s=mainDB.transaction([FILESTABLENAME],"readwrite").objectStore(FILESTABLENAME).put({path:e,data:t});s.onsuccess=(()=>{r({stat:1}),console.log(`save ${e} succeed`)}),s.onerror=(t=>{r({stat:0}),console.error(`save (${e}) error`,t)})});Object.defineProperty(base,"main",{value:{get agent(){return agent},get load(){return load},get fixUrlObj(){return fixUrlObj},get toUrlObjs(){return toUrlObjs},get setProcessor(){return setProcessor}}}),glo.load||(glo.load=drill.load);let cScript=document.currentScript;if(!cScript&&(cScript=document.querySelector(["drill-cache"])),cScript){let e=cScript.getAttribute("drill-cache");e&&(drill.cacheInfo.v=e)}let oldDrill=glo.drill;Object.defineProperty(glo,"drill",{get:()=>drill,set(e){isFunction(e)?nextTick(()=>e(drill)):console.error("drill type error =>",e)}}),oldDrill&&nextTick(()=>oldDrill(drill))})(window);