/*!
* drill.js v3.4.6
* https://github.com/kirakiray/drill.js
* 
* (c) 2018-2020 YAO
* Released under the MIT License.
*/(e=>{"use strict";const t=new Map,a=new Map,r=new Map,s=new Map,n={};let l={time:100,backups:[]},i={processors:t,loaders:a,bag:r,paths:s,dirpaths:n,errInfo:l,baseUrl:"",tempM:{}};const o=()=>Math.random().toString(32).substr(2);var c=Object.prototype.toString;const d=e=>(e=>c.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;const p=(()=>{if(null!==document.currentScript.getAttribute("debug"))return setTimeout;if("object"==typeof process&&process.nextTick)return process.nextTick;let e=!1,t=[];return a=>{e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a)}})(),u=e=>{let t=(e=(e=e.replace(/(.+)#.+/,"$1")).replace(/(.+)\?.+/,"$1")).match(/(.+\/).*/);return t&&t[1]},h=e=>{let t=[];return e.split(/\//g).forEach(e=>{".."==e&&t.length&&".."!=t.slice(-1)[0]?t.pop():t.push(e)}),t.join("/")},f=u(document.location.href);a.set("css",e=>new Promise((t,a)=>{let r=document.createElement("link");r.rel="stylesheet",r.href=e.link;let s=!1;r.onload=(()=>{document.head.removeChild(r),t(async e=>(s||e.param.includes("-getPath")||(s=!0,document.head.appendChild(r)),r))}),r.onerror=(e=>{a({desc:"load link error",target:r,event:e})}),document.head.appendChild(r)})),a.set("json",async e=>{let t=await fetch(e.link);return t=await t.json(),async()=>t}),a.set("wasm",async e=>{let t=await fetch(e.link);t=await t.arrayBuffer();let a=await WebAssembly.compile(t);const r=new WebAssembly.Instance(a);return async()=>r.exports}),a.set("frame",async e=>{let t=document.createElement("iframe");Object.assign(t.style,{position:"absolute","z-index":"-1",border:"none",outline:"none",opacity:"0",width:"0",height:"0"});let{link:a,path:s}=e,n=s.replace(/\.frame$/,"/frame.html"),l=a.replace(s,n);t.src=l;let i=new Map,c=()=>{r.delete(s),document.body.removeChild(t),window.removeEventListener("message",d),d=e=c=null};e.timer=setTimeout(c,1e4);let d,p=a=>new Promise(r=>{let s=o();clearTimeout(e.timer),i.set(s,{res:r}),t.contentWindow.postMessage({type:"drillFrameTask",taskId:s,data:a.data},"*")});return window.addEventListener("message",d=(t=>{let{data:a,taskId:r}=t.data;if(i.has(r)){let e=i.get(r);i.delete(r),e.res(a)}i.size||(e.timer=setTimeout(c,1e4))})),new Promise((e,a)=>{t.addEventListener("load",t=>{e(p)}),t.addEventListener("error",e=>{c(),a()}),document.body.appendChild(t)})}),a.set("js",e=>new Promise((a,s)=>{let n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=e.link,n.addEventListener("load",async()=>{let s,{tempM:n}=i,{type:l,moduleId:o}=n;o&&(r.get(o)||r.set(o,e));let c=t.get(l||"file");if(!c)throw"no such this processor => "+l;s=await c(e),a(s)}),n.addEventListener("error",()=>{s()}),document.head.appendChild(n)})),a.set("mjs",async e=>{let t=await import(e.link);return async()=>t});const m=new Set(["png","jpg","jpeg","bmp","gif","webp"]),b=e=>{let t=a.get(e);return t||(console.log("no such this loader => "+e),t=w),m.has(e)&&(t=k),t},w=async e=>{let t=await fetch(e.link);return t=await t.text(),async()=>t},k=async e=>{if(e.offlineUrl)return async()=>e.offlineUrl;let t=await fetch(e.link),a=await t.blob(),r=URL.createObjectURL(a);return async()=>r},g=e=>/^http/.test(e);let y=async e=>{if(e.param&&e.param.includes("-getLink")&&!v.cacheInfo.offline)return Promise.resolve(e.link);let t=r.get(e.path);if(!t){(t={stat:1,dir:e.dir,path:e.path,link:e.link,fileType:e.fileType}).passPromise=new Promise((e,a)=>{t._passResolve=e,t._passReject=a}),r.set(e.path,t);let a=[t.link];const s=()=>{t.stat=4,t._passReject({desc:"load source error",link:a,packData:t})};for(;;)try{t.link=await O({packData:t}),t.getPack=await b(e.fileType)(t)||(async()=>{}),t.stat=3,t._passResolve();break}catch(r){if(t.stat=2,g(e.str))break;let{backups:n}=l;if(!n.length){s();break}{let e=void 0!=t.backupId?t.backupId:t.backupId=-1;if(!(e<n.length)){t.stat=4,s();break}{let r=n[e]||i.baseUrl,o=location.href.replace(/(.+\/).+/,"$1");g(r)||(r=o+r);let c=n[e=++t.backupId];if(!c){s();break}g(c)||(c=o+c),t.link=t.link.replace(new RegExp("^"+r),c),a.push(t.link),await new Promise(e=>setTimeout(e,l.time))}}}}return await t.passPromise,e.param&&e.param.includes("-getLink")&&v.cacheInfo.offline?Promise.resolve(t.link):await t.getPack(e)};const v={load:(...e)=>I(x(e)),remove(e){let{path:t}=P({str:e});if(r.has(t))return r.delete(t),!0;console.warn(`pack %c${e}`,"color:red","does not exist")},has(e){let{path:t}=P({str:e}),a=r.get(t);return a&&a.stat},config(e){e.baseUrl&&(i.baseUrl=e.baseUrl);let t=e.paths;t&&Object.keys(t).forEach(e=>{/^@.+\/$/.test(e)?n[e]={reg:new RegExp("^"+e),value:t[e]}:s.set(e,t[e])}),i.baseUrl&&e.backups&&e.backups.forEach(e=>l.backups.push(e))},ext(e,t){if(d(e))e(i);else{let a,r=(...e)=>t(e,a,i);switch(e){case"fixUrlObj":a=P,P=r;break;case"load":a=I,I=r;break;case"agent":a=y,y=r;break;case"cacheSource":a=O,O=r}}},cacheInfo:{k:"d_ver",v:"",offline:!1},debug:{bag:r},version:"3.4.6",v:3004006};let j=(a,r)=>{t.set(a,async e=>{let t=i.tempM.d;return i.tempM={},await r(e,t,{relativeLoad:(...t)=>I(x(t,e.dir))})});let s=(e,t)=>{i.tempM={type:a,d:e,moduleId:t}};v[a]||(v[a]=s),e[a]||(e[a]=s)},I=e=>{let t,a=new Promise((a,r)=>{let s=[],{length:n}=e,l=n,i=[];e.forEach(async(e,o)=>{let c,d="succeed";await new Promise(e=>p(e)),c=await y(e).catch(t=>{d="error",Object.assign(e,{type:"error",descript:t}),i.push(e)}),s[o]=c,t&&t({id:o,sum:l,ready:l-n+1,stat:d}),--n||(i.length?r(i):a(1==l?c:s),s=null)})});return a.post=function(t){return e.forEach(e=>e.data=t),this},a.pend=function(e){return t=e,this},a},P=e=>{let{str:t}=e;if(r.has(t)){let a=r.get(t);return Object.assign(e,{path:a.path,link:a.link,dir:a.dir}),e}let a=t.split(/\s/).filter(e=>e&&e),l=a.slice(1),o=a[0],c=o.match(/(.+)\?(\S+)$/)||"";c&&(o=c[1],c=c[2]);let{k:d,v:p}=v.cacheInfo;d&&p&&(c&&(c+="&"),c+=d+"="+p);let m=s.get(o);if(m)o=m;else for(let e in n){let t=n[e];if(t.reg.test(o)){o=o.replace(t.reg,t.value);break}}let b,w=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(o)||"js";if(o=o.replace(new RegExp("\\."+w+"$"),""),b=l.includes("-r")||/^.+:\/\//.test(o)?o:/^\./.test(o)?e.relative?o=e.relative+o:o.replace(/^\.\//,""):i.baseUrl+o,l.includes("-pack")){let e=b.match(/(.+)\/(.+)/);o=b=e&&2 in e?e[1]+"/"+e[2]+"/"+e[2]:`${b}/${b}`}/^.+:\/\//.test(b)||(b=f+b),b=b.replace(/\/\.\//,"/"),o=o.replace(/\/\.\//,"/"),/\.\.\//.test(b)&&(b=h(b),o=h(o));let k=u(b+="."+w),g=c?b+"?"+c:b;return l.includes("-mjs")&&(w="mjs"),Object.assign(e,{link:g,search:c,ori:o,fileType:w,path:b,dir:k,param:l}),e};const x=(e,t)=>{let a=o();return e.map((e,r)=>P({loadId:o(),id:r,str:e,groupId:a,relative:t}))};t.set("file",e=>{}),j("define",async(e,t,{relativeLoad:a})=>{let r={},s={exports:r};if(d(t)){let{path:n,dir:l}=e;t=t(a,r,s,{FILE:n,DIR:l})}return t instanceof Promise&&(t=await t),t||(e=>!(0 in Object.keys(e)))(s.exports)||(t=s.exports),async()=>t}),j("task",(e,t,{relativeLoad:a})=>{if(!d(t))throw"task must be a function";let{path:r,dir:s}=e;return async e=>{return await t(a,e.data,{FILE:r,DIR:s})}}),j("init",(e,t,{relativeLoad:a})=>{if(!d(t))throw"init must be a function";let r,{path:s,dir:n}=e,l=0;return async e=>l?r:(r=await t(a,e.data,{FILE:s,DIR:n}),l=1,r)});let E,L=new Promise((t,a)=>{const r=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.msIndexedDB;if(r){let e=r.open("drill-cache-db",v.cacheInfo.v||1);e.onupgradeneeded=(e=>{let t=e.target.result;t.objectStoreNames.contains("files")?(t.deleteObjectStore("files"),t.createObjectStore("files",{keyPath:"path"})):t.createObjectStore("files",{keyPath:"path"})}),e.onsuccess=(e=>{E=e.target.result,t()})}else a("rubish browser no indexDB")}),O=async({packData:e})=>{if(!v.cacheInfo.offline)return e.link;await L;let t=await U(e.path);if(!t){let a=await fetch(e.link);if(200!=a.status)throw{type:"cacheSource",desc:"statusError",status:a.status};let r=a.headers.get("Content-Type").replace(/;.+/,""),s=e.path.replace(/.+\//,""),n=await a.blob();t=new File([n],s,{type:r}),await S(e.path,t)}return e.offlineFile=t,e.offlineUrl=URL.createObjectURL(t)};const U=e=>new Promise((t,a)=>{let r=E.transaction(["files"],"readonly").objectStore("files").get(e);r.onsuccess=(()=>{t(r.result&&r.result.data)}),r.onerror=(t=>{a(),console.error(`error load ${e}`,t)})}),S=(e,t)=>new Promise((a,r)=>{let s=E.transaction(["files"],"readwrite").objectStore("files").put({path:e,data:t});s.onsuccess=(()=>{a({stat:1}),console.log(`save ${e} succeed`)}),s.onerror=(t=>{a({stat:0}),console.error(`save (${e}) error`,t)})});Object.defineProperty(i,"main",{value:{get agent(){return y},get load(){return I},get fixUrlObj(){return P},get toUrlObjs(){return x},get setProcessor(){return j}}}),e.load||(e.load=v.load);let R=document.currentScript;if(!R&&(R=document.querySelector(["drill-cache"])),R){let e=R.getAttribute("drill-cache");e&&(v.cacheInfo.v=e)}let T=e.drill;Object.defineProperty(e,"drill",{get:()=>v,set(e){d(e)?p(()=>e(v)):console.error("drill type error =>",e)}}),T&&p(()=>T(v))})(window);