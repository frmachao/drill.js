/*!
* drill.js v3.3.0
* https://github.com/kirakiray/drill.js
* 
* (c) 2018-2020 YAO
* Released under the MIT License.
*/(e=>{"use strict";const t=new Map,a=new Map,r=new Map,s=new Map,n={};let l={loadNum:3,time:1e3,backups:new Set},i={processors:t,loaders:a,bag:r,paths:s,dirpaths:n,errInfo:l,baseUrl:"",tempM:{}};const o=()=>Math.random().toString(32).substr(2);var c=Object.prototype.toString;const d=e=>(e=>c.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;const p=(()=>{let e=!1,t=[];return a=>{e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a)}})(),u=e=>{let t=e.match(/(.+\/).*/);return t&&t[1]},h=e=>{let t=[];return e.split(/\//g).forEach(e=>{".."==e&&t.length&&".."!=t.slice(-1)[0]?t.pop():t.push(e)}),t.join("/")},m=u(document.location.href);a.set("css",e=>new Promise((t,a)=>{let r=document.createElement("link");r.rel="stylesheet",r.href=e.link,r.onload=(()=>{t()}),r.onerror=(()=>{a()}),document.head.appendChild(r)})),a.set("json",async e=>{let t=await fetch(e.link);return t=await t.json(),async()=>t}),a.set("wasm",async e=>{let t=await fetch(e.link);t=await t.arrayBuffer();let a=await WebAssembly.compile(t);const r=new WebAssembly.Instance(a);return async()=>r.exports}),a.set("frame",async e=>{let t=document.createElement("iframe");Object.assign(t.style,{position:"absolute","z-index":"-1",border:"none",outline:"none",opacity:"0",width:"0",height:"0"});let{link:a,path:s}=e,n=s.replace(/\.frame$/,"/frame.html"),l=a.replace(s,n);t.src=l;let i=new Map,c=()=>{r.delete(s),document.body.removeChild(t),window.removeEventListener("message",d),d=e=c=null};e.timer=setTimeout(c,1e4);let d,p=a=>new Promise(r=>{let s=o();clearTimeout(e.timer),i.set(s,{res:r}),t.contentWindow.postMessage({type:"drillFrameTask",taskId:s,data:a.data},"*")});return window.addEventListener("message",d=(t=>{let{data:a,taskId:r}=t.data;if(i.has(r)){let e=i.get(r);i.delete(r),e.res(a)}i.size||(e.timer=setTimeout(c,1e4))})),new Promise((e,a)=>{t.addEventListener("load",t=>{e(p)}),t.addEventListener("error",e=>{c(),a()}),document.body.appendChild(t)})}),a.set("js",e=>new Promise((a,s)=>{let n=document.createElement("script");n.type="text/javascript",n.async=!0,n.src=e.link,n.addEventListener("load",async()=>{let s,{tempM:n}=i,{type:l,moduleId:o}=n;o&&(r.get(o)||r.set(o,e));let c=t.get(l||"file");if(!c)throw"no such this processor => "+l;s=await c(e),i.tempM={},a(s)}),n.addEventListener("error",()=>{s()}),document.head.appendChild(n)}));const f=async e=>{let t;try{t=await fetch(e.link)}catch(t){return void(e.stat=2)}t=await t.text(),e.getPack=(async()=>t),e.stat=3};let g=async e=>{let t=r.get(e.path);if(!t){t={stat:1,dir:e.dir,path:e.path,link:e.link,fileType:e.fileType},r.set(e.path,t);try{t.getPack=await(e=>{let t=a.get(e);return t||(console.log("no such this loader => "+e),t=f),t})(e.fileType)(t)||(async()=>{})}catch(e){}}return await t.getPack(e)};const w={load:(...e)=>b(v(e)),remove(e){let{path:t}=k({str:e});if(r.has(t))return r.delete(t),!0;console.warn(`pack %c${e}`,"color:red","does not exist")},has(e){let{path:t}=k({str:e}),a=r.get(t);return a&&a.stat},config(e){e.baseUrl&&(i.baseUrl=e.baseUrl);let t=e.paths;t&&Object.keys(t).forEach(e=>{/\/$/.test(e)?n[e]={reg:new RegExp("^"+e),value:t[e]}:s.set(e,t[e])}),i.baseUrl&&e.backups&&e.backups.forEach(e=>{l.backups.add(e)})},ext(e,t){if(d(e))e(i);else{let a,r=(...e)=>t(e,a,i);switch(e){case"fixUrlObj":a=k,k=r;break;case"load":a=b,b=r;break;case"agent":a=g,g=r}}},cacheInfo:{k:"d_ver",v:""},debug:{bag:r},version:"3.3.0",v:3003e3};let y=(a,r)=>{t.set(a,async e=>await r(e,i.tempM.d));let s=(e,t)=>{i.tempM={type:a,d:e,moduleId:t}};w[a]||(w[a]=s),e[a]||(e[a]=s)},b=e=>{let t,a=new Promise((a,r)=>{let s=[],{length:n}=e,l=n,i=[];e.forEach(async(e,o)=>{let c,d="succeed";e.param&&e.param.includes("-getPath")?c=e.link:(await new Promise(e=>p(e)),c=await g(e).catch(t=>{d="error",Object.assign(e,{type:"error",descript:t}),i.push(e)})),s[o]=c,t&&t({id:o,sum:l,ready:l-n+1,stat:d}),--n||(i.length?r(i):a(1==l?c:s),s=null)})});return a.post=function(t){return e.forEach(e=>e.data=t),this},a.pend=function(e){return t=e,this},a},k=e=>{let{str:t}=e;if(r.has(t)){let a=r.get(t);return Object.assign(e,{path:a.path,link:a.link,dir:a.dir}),e}let a=t.split(/\s/).filter(e=>e&&e),l=a.slice(1),o=a[0],c=o.match(/(.+)\?(\S+)$/)||"";c&&(o=c[1],c=c[2]);let{k:d,v:p}=w.cacheInfo;d&&p&&(c&&(c+="&"),c+=d+"="+p);let f=s.get(o);if(f)o=f;else for(let e in n){let t=n[e];if(t.reg.test(o)){o=o.replace(t.reg,t.value);break}}let g,y=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(o)||"js";if(o=o.replace(new RegExp("\\."+y+"$"),""),g=l.indexOf("-r")>-1||/^.+:\/\//.test(o)?o:/^\./.test(o)?e.relative?o=e.relative+o:o.replace(/^\.\//,""):i.baseUrl+o,l.includes("-pack")){let e=g.match(/(.+)\/(.+)/);o=g=e&&2 in e?e[1]+"/"+e[2]+"/"+e[2]:`${g}/${g}`}/^.+:\/\//.test(g)||(g=m+g),g=g.replace(/\/\.\//,"/"),o=o.replace(/\/\.\//,"/"),/\.\.\//.test(g)&&(g=h(g),o=h(o));let b=u(g+="."+y),k=c?g+"?"+c:g;return Object.assign(e,{link:k,search:c,ori:o,fileType:y,path:g,dir:b,param:l}),e};const v=(e,t)=>{let a=o();return e.map((e,r)=>k({loadId:o(),id:r,str:e,groupId:a,relative:t}))};t.set("file",e=>{}),y("define",async(e,t)=>{let a={},r={exports:a};if(d(t)){let{path:s,dir:n}=e;t=t((...e)=>b(v(e,n)),a,r,{FILE:s,DIR:n})}return t instanceof Promise&&(t=await t),t||(e=>!(0 in Object.keys(e)))(r.exports)||(t=r.exports),async()=>t}),y("task",(e,t)=>{if(!d(t))throw"task must be a function";let{path:a,dir:r}=e;return async e=>{return await t((...e)=>b(v(e,r)),e.data,{FILE:a,DIR:r})}}),y("init",(e,t)=>{if(!d(t))throw"init must be a function";let a,{path:r,dir:s}=e,n=0;return async e=>n?a:(a=await t((...e)=>b(v(e,s)),e.data,{FILE:r,DIR:s}),n=1,a)});let j={get agent(){return g},get load(){return b},get fixUrlObj(){return k},get toUrlObjs(){return v},get setProcessor(){return y}};Object.defineProperty(i,"main",{value:j}),e.load||(e.load=w.load);let E=document.currentScript;if(!E&&(E=document.querySelector(["drill-cache"])),E){let e=E.getAttribute("drill-cache");e&&(w.cacheInfo.v=e)}let I=e.drill;Object.defineProperty(e,"drill",{get:()=>w,set(e){d(e)?p(()=>e(w)):console.error("drill type error =>",e)}}),I&&p(()=>I(w))})(window);