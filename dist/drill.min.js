(e=>{"use strict";const t=new Map,a=new Map,r=new Map,s=new Map,n={};let l={loadNum:3,time:1e3,backups:new Set},i={processors:t,loaders:a,bag:r,paths:s,dirpaths:n,errInfo:l,baseUrl:"",tempM:{}};const c=()=>Math.random().toString(32).substr(2);var o=Object.prototype.toString;const d=e=>(e=>o.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;const p=(()=>{let e=!1,t=[];return a=>{e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a)}})(),u=e=>{let t=e.match(/(.+\/).+/);return t&&t[1]},h=e=>{let t=[];return e.split(/\//g).forEach(e=>{".."==e&&t.length&&".."!=t.slice(-1)[0]?t.pop():t.push(e)}),t.join("/")},m=u(document.location.href);a.set("css",e=>{let t=document.createElement("link");t.rel="stylesheet",t.href=e.link,t.onload=(()=>{e.stat=3}),t.onerror=(()=>{e.stat=2}),document.head.appendChild(t)}),a.set("json",async e=>{let t;try{t=await fetch(e.link)}catch(t){return void(e.stat=2)}t=await t.json(),e.getPack=(async()=>t),e.stat=3}),a.set("wasm",async e=>{let t;try{t=await fetch(e.link)}catch(t){return void(e.stat=2)}t=await t.arrayBuffer();let a=await WebAssembly.compile(t);const r=new WebAssembly.Instance(a);e.getPack=(async()=>r.exports),e.stat=3}),a.set("frame",async e=>{let t=document.createElement("iframe");Object.assign(t.style,{position:"absolute","z-index":"-1",border:"none",outline:"none",opacity:"0",width:"0",height:"0"});let{link:a,path:s}=e,n=s.replace(/\.frame$/,"/frame.html"),l=a.replace(s,n);t.src=l;let i=new Map,o=()=>{r.delete(s),document.body.removeChild(t),window.removeEventListener("message",d),d=e=o=null};e.timer=setTimeout(o,1e4),e.getPack=(a=>new Promise(r=>{let s=c();clearTimeout(e.timer),i.set(s,{res:r}),t.contentWindow.postMessage({type:"drillFrameTask",taskId:s,data:a.data},"*")}));let d;window.addEventListener("message",d=(t=>{let{data:a,taskId:r}=t.data;if(i.has(r)){let e=i.get(r);i.delete(r),e.res(a)}i.size||(e.timer=setTimeout(o,1e4))})),t.addEventListener("load",t=>{e.stat=3}),t.addEventListener("error",t=>{e.stat=2}),document.body.appendChild(t)}),a.set("js",e=>{let a=document.createElement("script");a.type="text/javascript",a.async=!0,a.src=e.link,a.addEventListener("load",()=>{let{tempM:a}=i,{type:s,moduleId:n}=a;n&&(r.get(n)||r.set(n,e));let l=t.get(s||"file");if(!l)throw"no such this processor => "+s;l(e),i.tempM={}}),a.addEventListener("error",()=>{e.stat=2}),document.head.appendChild(a)}),t.set("file",e=>{e.stat=3}),t.set("define",async e=>{let t=i.tempM.d,a={},r={exports:a};if(d(t)){let{path:s,dir:n}=e;t=t((...e)=>b(w(e,n)),a,r,{FILE:s,DIR:n})}t instanceof Promise&&(t=await t),t||(e=>!(0 in Object.keys(e)))(r.exports)||(t=r.exports),e.getPack=(async()=>t),e.stat=3}),t.set("task",e=>{let t=i.tempM.d;if(!d(t))throw"task must be a function";let{path:a,dir:r}=e;e.getPack=(async e=>{return await t((...e)=>b(w(e,r)),e.data,{FILE:a,DIR:r})}),e.stat=3}),t.set("init",e=>{let t=i.tempM.d;if(!d(t))throw"init must be a function";let a,{path:r,dir:s}=e,n=0;e.getPack=(async e=>n?a:(a=await t((...e)=>b(w(e,s)),e.data,{FILE:r,DIR:s}),n=1,a)),e.stat=3});const f=e=>{let t=a.get(e);return t||(console.log("no such this loader => "+e),t=g),t},g=async e=>{let t;try{t=await fetch(e.link)}catch(t){return void(e.stat=2)}t=await t.text(),e.getPack=(async()=>t),e.stat=3};let k=e=>{let t=r.get(e.path);if(!t){let a=1;t={get stat(){return a},set stat(e){let t=a;a=e,this.changes.forEach(e=>e({change:"stat",oldStat:t,stat:a}))},dir:e.dir,path:e.path,link:e.link,dir:e.dir,changes:new Set,fileType:e.fileType,async getPack(e){}},r.set(e.path,t),f(e.fileType)(t)}return new Promise((a,r)=>{switch(t.stat){case 2:case 1:let s;t.changes.add(s=(n=>{let{stat:i}=n;switch(i){case 3:t.getPack(e).then(a),t.changes.delete(s),t=null;break;case 2:if((void 0!=t.loadCount?t.loadCount:t.loadCount=0)<l.loadNum)t.loadCount++,setTimeout(()=>f(t.fileType)(t),l.time);else{let{backups:e}=l;if(e.size){let a=void 0!=t.backupId?t.backupId:t.backupId=-1;if(a<e.size){let r=Array.from(e),s=r[a]||t.dir,n=r[a=++t.backupId];return t.loadCount=1,t.link=t.link.replace(new RegExp("^"+s),n),void setTimeout(()=>f(t.fileType)(t),l.time)}}t.stat=4}break;case 4:r("source error")}}));break;case 3:p(()=>{t.getPack(e).then(a)});break;case 4:r("source error")}})},b=e=>{let t,a=new Promise((a,r)=>{let s=[],{length:n}=e,l=n,i=[];e.forEach(async(e,c)=>{let o,d="succeed";o=e.param&&e.param.includes("-getPath")?e.link:await k(e).catch(t=>{d="error",Object.assign(e,{type:"error",descript:t}),i.push(e)}),s[c]=o,t&&t({id:c,sum:l,ready:l-n+1,stat:d}),--n||(i.length?r(i):a(1==l?o:s),s=null)})});return a.post=function(t){return e.forEach(e=>e.data=t),this},a.pend=function(e){return t=e,this},a},y=e=>{let{str:t}=e;if(r.has(t)){let a=r.get(t);return Object.assign(e,{path:a.path,link:a.link,dir:a.dir}),e}let a=t.split(/\s/).filter(e=>e&&e),l=a.slice(1),c=a[0],o=c.match(/(.+)\?(\S+)$/)||"";o&&(c=o[1],o=o[2]);let{k:d,v:p}=v.cacheInfo;d&&p&&(o&&(o+="&"),o+=d+"="+p);let f=s.get(c);if(f)c=f;else for(let e in n){let t=n[e];if(t.reg.test(c)){c=c.replace(t.reg,t.value);break}}let g=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(c)||"js";c=c.replace(new RegExp("\\."+g+"$"),"");let k;if(k=l.indexOf("-r")>-1||/^.+:\/\//.test(c)?c:/^\./.test(c)?e.relative?c=e.relative+c:c.replace(/^\.\//,""):i.baseUrl+c,l.includes("-pack")){let e=k.match(/(.+)\/(.+)/);c=k=e&&2 in e?e[1]+"/"+e[2]+"/"+e[2]:`${k}/${k}`}/^.+:\/\//.test(k)||(k=m+k),k=k.replace(/\/\.\//,"/"),c=c.replace(/\/\.\//,"/"),/\.\.\//.test(k)&&(k=h(k),c=h(c));let b=u(k+="."+g),y=o?k+"?"+o:k;return Object.assign(e,{link:y,search:o,ori:c,fileType:g,path:k,dir:b,param:l}),e};const w=(e,t)=>{let a=c();return e.map((e,r)=>y({loadId:c(),id:r,str:e,groupId:a,relative:t}))},v={load:(...e)=>b(w(e)),remove(e){let{path:t}=y({str:e});if(r.has(t))return r.delete(t),!0;console.warn(`pack %c${e}`,"color:red","does not exist")},has(e){let{path:t}=y({str:e}),a=r.get(t);return a&&a.stat},config(e){e.baseUrl&&(i.baseUrl=e.baseUrl);let t=e.paths;t&&Object.keys(t).forEach(e=>{/\/$/.test(e)?n[e]={reg:new RegExp("^"+e),value:t[e]}:s.set(e,t[e])}),i.baseUrl&&e.backups&&e.backups.forEach(e=>{l.backups.add(e)})},define(e,t){i.tempM={type:"define",d:e,moduleId:t}},task(e,t){i.tempM={type:"task",d:e,moduleId:t}},init(e,t){i.tempM={type:"init",d:e,moduleId:t}},ext(e,t){if(d(e))e(i);else{let a,r=(...e)=>t(e,a,i);switch(e){case"fixUrlObj":a=y,y=r;break;case"load":a=b,b=r;break;case"agent":a=k,k=r}}},cacheInfo:{k:"d_ver",v:""},debug:{bag:r},version:3002002};let I={get agent(){return k},get load(){return b},get fixUrlObj(){return y},get toUrlObjs(){return w}};Object.defineProperty(i,"main",{value:I}),e.load||(e.load=v.load),e.define||(e.define=v.define),e.task||(e.task=v.task),e.init||(e.init=v.init);let E=document.currentScript;if(!E&&(E=document.querySelector(["drill-cache"])),E){let e=E.getAttribute("drill-cache");e&&(v.cacheInfo.v=e)}let j=e.drill;Object.defineProperty(e,"drill",{get:()=>v,set(e){d(e)?p(()=>e(v)):console.error("drill type error =>",e)}}),j&&p(()=>j(v))})(window);