/*!
* drill.js v3.5.0
* https://github.com/kirakiray/drill.js
* 
* (c) 2018-2020 YAO
* Released under the MIT License.
*/(e=>{"use strict";const t=new Map,a=new Map,r=new Map,s=new Map,l={};let n=!1;const i=new Map;let o={time:100,backups:[]},c={processors:t,loaders:a,bag:r,paths:s,dirpaths:l,errInfo:o,baseUrl:"",tempM:{}};const p=()=>Math.random().toString(32).substr(2);var d=Object.prototype.toString;const u=e=>(e=>d.call(e).toLowerCase().replace(/(\[object )|(])/g,""))(e).search("function")>-1;const m=(()=>{if(null!==document.currentScript.getAttribute("debug"))return setTimeout;if("object"==typeof process&&process.nextTick)return process.nextTick;let e=!1,t=[];return a=>{e||(e=!0,setTimeout(()=>{for(let e=0;e<t.length;e++)t[e]();t=[],e=!1},0)),t.push(a)}})(),h=e=>{let t=(e=(e=e.replace(/(.+)#.+/,"$1")).replace(/(.+)\?.+/,"$1")).match(/(.+\/).*/);return t&&t[1]},f=e=>{let t=[];return e.split(/\//g).forEach(e=>{".."==e&&t.length&&".."!=t.slice(-1)[0]?t.pop():t.push(e)}),t.join("/")},w=h(document.location.href);a.set("css",e=>new Promise((t,a)=>{let r=document.createElement("link");r.rel="stylesheet",r.href=e.link;let s=!1;r.onload=(async()=>{document.head.removeChild(r),t(async e=>(s||e.param.includes("-unAppend")||(s=!0,document.head.appendChild(r)),r))}),r.onerror=(e=>{a({desc:"load link error",target:r,event:e})}),document.head.appendChild(r)})),a.set("json",async e=>{let t=await fetch(e.link);return t=await t.json(),async()=>t}),a.set("wasm",async e=>{let t=await fetch(e.link);t=await t.arrayBuffer();let a=await WebAssembly.compile(t);const r=new WebAssembly.Instance(a);return async()=>r.exports}),a.set("frame",async e=>{let t=document.createElement("iframe");Object.assign(t.style,{position:"absolute","z-index":"-1",border:"none",outline:"none",opacity:"0",width:"0",height:"0"});let{link:a,path:s}=e,l=s.replace(/\.frame$/,"/frame.html"),n=a.replace(s,l);t.src=n;let i=new Map,o=()=>{r.delete(s),document.body.removeChild(t),window.removeEventListener("message",c),c=e=o=null};e.timer=setTimeout(o,1e4);let c,d=a=>new Promise(r=>{let s=p();clearTimeout(e.timer),i.set(s,{res:r}),t.contentWindow.postMessage({type:"drillFrameTask",taskId:s,data:a.data},"*")});return window.addEventListener("message",c=(t=>{let{data:a,taskId:r}=t.data;if(i.has(r)){let e=i.get(r);i.delete(r),e.res(a)}i.size||(e.timer=setTimeout(o,1e4))})),new Promise((e,a)=>{t.addEventListener("load",t=>{e(d)}),t.addEventListener("error",e=>{o(),a()}),document.body.appendChild(t)})}),a.set("js",e=>new Promise((a,s)=>{let l=document.createElement("script");l.type="text/javascript",l.async=!0,l.src=e.link,l.addEventListener("load",async()=>{let s,{tempM:l}=c,{type:n,moduleId:i}=l;i&&(r.get(i)||r.set(i,e));let o=t.get(n||"file");if(!o)throw"no such this processor => "+n;s=await o(e),a(s)}),l.addEventListener("error",()=>{s()}),document.head.appendChild(l)})),a.set("mjs",async e=>{let t=await import(e.link);return async()=>t});const b=new Set(["png","jpg","jpeg","bmp","gif","webp"]),g=e=>{let t=a.get(e);return t||(console.log("no such this loader => "+e),t=k),b.has(e)&&(t=y),t},k=async e=>{let t=await fetch(e.link);return t=await t.text(),async()=>t},y=async e=>{if(e.offlineUrl)return async()=>e.offlineUrl;let t=await fetch(e.link),a=await t.blob(),r=URL.createObjectURL(a);return async()=>r},v=e=>/^http/.test(e);let j=async e=>{if(e.param&&e.param.includes("-getLink")&&!n)return Promise.resolve(e.link);let t=r.get(e.path);if(!t){(t={stat:1,dir:e.dir,path:e.path,link:e.link,fileType:e.fileType}).passPromise=new Promise((e,a)=>{t._passResolve=e,t._passReject=a}),r.set(e.path,t);let a=[t.link];const s=e=>{t.stat=4,t._passReject({desc:"load source error",link:a,packData:t})};for(;;)try{t.link=await U({packData:t}),t.getPack=await g(e.fileType)(t)||(async()=>{}),t.stat=3,t._passResolve();break}catch(r){if(t.stat=2,v(e.str))break;let{backups:l}=o;if(!l.length){s();break}{let e=void 0!=t.backupId?t.backupId:t.backupId=-1;if(!(e<l.length)){t.stat=4,s();break}{let r=l[e]||c.baseUrl,n=location.href.replace(/(.+\/).+/,"$1");v(r)||(r=n+r);let i=l[e=++t.backupId];if(!i){s();break}v(i)||(i=n+i),t.link=t.link.replace(new RegExp("^"+r),i),a.push(t.link),await new Promise(e=>setTimeout(e,o.time))}}}}return await t.passPromise,e.param&&e.param.includes("-getLink")&&n?Promise.resolve(t.link):await t.getPack(e)};const P={load:(...e)=>x(E(e)),remove(e){let{path:t}=I({str:e});if(r.has(t))return r.delete(t),!0;console.warn(`pack %c${e}`,"color:red","does not exist")},has(e){let{path:t}=I({str:e}),a=r.get(t);return a&&a.stat},config(e){e.baseUrl&&(c.baseUrl=e.baseUrl);let t=e.paths;t&&Object.keys(t).forEach(e=>{/^@.+\/$/.test(e)?l[e]={reg:new RegExp("^"+e),value:t[e]}:s.set(e,t[e])}),c.baseUrl&&e.backups&&e.backups.forEach(e=>o.backups.push(e))},ext(e,t){if(u(e))e(c);else{let a,r=(...e)=>t(e,a,c);switch(e){case"fixUrlObj":a=I,I=r;break;case"load":a=x,x=r;break;case"agent":a=j,j=r;break;case"cacheSource":a=U,U=r}}},cacheInfo:{k:"d_ver",v:""},get offline(){return n},set offline(e){n?console.error("offline mode has been activated"):n=e},debug:{bag:r},version:"3.5.0",v:3005e3},L=(a,r)=>{t.set(a,async e=>{let t=c.tempM.d;return c.tempM={},await r(e,t,{relativeLoad:(...t)=>x(E(t,e.dir))})});let s=(e,t)=>{c.tempM={type:a,d:e,moduleId:t}};P[a]||(P[a]=s),e[a]||(e[a]=s)},$=(e,t)=>{i.set(e,async({file:e,packData:a})=>{let r=e,s=await e.text(),l=await t({fileText:s,file:e,relativeLoad:(...e)=>x(E(e,a.dir))});return s!==l&&(r=new File([l],e.name,{type:e.type})),r})};let x=e=>{let t,a=new Promise((a,r)=>{let s=[],{length:l}=e,n=l,i=[];e.forEach(async(e,o)=>{let c,p="succeed";await new Promise(e=>m(e)),c=await j(e).catch(t=>{p="error",Object.assign(e,{type:"error",descript:t}),i.push(e)}),s[o]=c,t&&t({id:o,sum:n,ready:n-l+1,stat:p}),--l||(i.length?r(i):a(1==n?c:s),s=null)})});return a.post=function(t){return e.forEach(e=>e.data=t),this},a.pend=function(e){return t=e,this},a},I=e=>{let{str:t}=e;if(r.has(t)){let a=r.get(t);return Object.assign(e,{path:a.path,link:a.link,dir:a.dir}),e}let a=t.split(/\s/).filter(e=>e&&e),n=a.slice(1),i=a[0],o=i.match(/(.+)\?(\S+)$/)||"";o&&(i=o[1],o=o[2]);let{k:p,v:d}=P.cacheInfo;p&&d&&!n.includes("-unCacheSearch")&&(o&&(o+="&"),o+=p+"="+d);let u=s.get(i);if(u)i=u;else for(let e in l){let t=l[e];if(t.reg.test(i)){i=i.replace(t.reg,t.value);break}}let m,b=(e=>{let t,a=e.split("/").pop().match(/(.+)\.(.+)/);return a&&(t=a[2]),t})(i)||"js";if(i=i.replace(new RegExp("\\."+b+"$"),""),m=n.includes("-r")||/^.+:\/\//.test(i)?i:/^\./.test(i)?e.relative?i=e.relative+i:i.replace(/^\.\//,""):c.baseUrl+i,n.includes("-pack")){let e=m.match(/(.+)\/(.+)/);i=m=e&&2 in e?e[1]+"/"+e[2]+"/"+e[2]:`${m}/${m}`}/^.+:\/\//.test(m)||(m=w+m),m=m.replace(/\/\.\//,"/"),i=i.replace(/\/\.\//,"/"),/\.\.\//.test(m)&&(m=f(m),i=f(i));let g=h(m+="."+b),k=o?m+"?"+o:m;return n.includes("-mjs")&&(b="mjs"),Object.assign(e,{link:k,search:o,ori:i,fileType:b,path:m,dir:g,param:n}),e};const E=(e,t)=>{let a=p();return e.map((e,r)=>I({loadId:p(),id:r,str:e,groupId:a,relative:t}))};t.set("file",e=>{}),L("define",async(e,t,{relativeLoad:a})=>{let r={},s={exports:r};if(u(t)){let{path:l,dir:n}=e;t=t(a,r,s,{FILE:l,DIR:n})}return t instanceof Promise&&(t=await t),t||(e=>!(0 in Object.keys(e)))(s.exports)||(t=s.exports),async()=>t}),L("task",(e,t,{relativeLoad:a})=>{if(!u(t))throw"task must be a function";let{path:r,dir:s}=e;return async e=>{return await t(a,e.data,{FILE:r,DIR:s})}}),L("init",(e,t,{relativeLoad:a})=>{if(!u(t))throw"init must be a function";let r,{path:s,dir:l}=e,n=0;return async e=>n?r:(r=await t(a,e.data,{FILE:s,DIR:l}),n=1,r)}),$("css",async({fileText:e,relativeLoad:t})=>{let a=e.match(/@import ["'](.+?)["']/g);a&&await Promise.all(a.map(async a=>{let r=a.replace(/@import ["'](.+?)["']/,"$1"),s=await t(`${r} -getLink`);e=e.replace(a,`@import "${s}"`)}));let r=e.match(/url\((.+?)\)/g);return r&&await Promise.all(r.map(async a=>{let r=a.replace(/url\((.+?)\)/,"$1").replace(/["']/g,"");if(/(^http:)|(^https:)/.test(r))return Promise.resolve("");let s=await t(`${r} -getLink`);e=e.replace(a,`url("${s}")`)})),e}),$("mjs",async({fileText:e,relativeLoad:t})=>{let a=e.match(/import .+ from ['"](.+?)['"];/g);a&&await Promise.all(a.map(async a=>{let r=a.match(/(import .+ from) ['"](.+?)['"];/,"$1");if(r){let s=r[2],l=await t(`${s} -getLink`);e=e.replace(a,`${r[1]} "${l}"`)}}));let r=e.match(/import\(.+?\)/g);return r&&await Promise.all(r.map(async a=>{let r=a.replace(/import\(["'](.+?)['"]\)/,"$1"),s=await t(`${r} -getLink`);e=e.replace(a,`import("${s}")`)})),e});let T,O=new Promise((t,a)=>{const r=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.msIndexedDB;if(r){let e=r.open("drill-cache-db",P.cacheInfo.v||1);e.onupgradeneeded=(e=>{let t=e.target.result;t.objectStoreNames.contains("files")?(t.deleteObjectStore("files"),t.createObjectStore("files",{keyPath:"path"})):t.createObjectStore("files",{keyPath:"path"})}),e.onsuccess=(e=>{T=e.target.result,t()})}else a("rubish browser no indexDB")}),U=async({packData:e})=>{if(!n)return e.link;await O;let t=await S(e.path);if(!t){let a=await fetch(e.link);if(200!=a.status)throw{type:"cacheSource",desc:"statusError",status:a.status};let r=a.headers.get("Content-Type").replace(/;.+/,""),s=e.path.replace(/.+\//,""),l=await a.blob();t=new File([l],s,{type:r}),await R(e.path,t)}let a=i.get(e.fileType);return a&&(t=await a({file:t,packData:e})),e.offlineFile=t,e.offlineUrl=URL.createObjectURL(t)};const S=e=>new Promise((t,a)=>{let r=T.transaction(["files"],"readonly").objectStore("files").get(e);r.onsuccess=(()=>{t(r.result&&r.result.data)}),r.onerror=(t=>{a(),console.error(`error load ${e}`,t)})}),R=(e,t)=>new Promise((a,r)=>{let s=T.transaction(["files"],"readwrite").objectStore("files").put({path:e,data:t});s.onsuccess=(()=>{a({stat:1}),console.log(`save ${e} succeed`)}),s.onerror=(t=>{a({stat:0}),console.error(`save (${e}) error`,t)})});Object.defineProperty(c,"main",{value:{get agent(){return j},get load(){return x},get fixUrlObj(){return I},get toUrlObjs(){return E},get setProcessor(){return L}}}),e.load||(e.load=P.load);let D=document.currentScript;if(!D&&(D=document.querySelector(["drill-cache"])),D){let e=D.getAttribute("drill-cache");e&&(P.cacheInfo.v=e)}let M=e.drill;Object.defineProperty(e,"drill",{get:()=>P,set(e){u(e)?m(()=>e(P)):console.error("drill type error =>",e)}}),M&&m(()=>M(P))})(window);